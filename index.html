<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* === STILI BASE === */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
    padding: 20px;
    font-size: 14px;
    line-height: 1.4;
}

/* === HEADER PRINCIPALE === */
.main-header {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 25px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.main-header h1 {
    font-size: 28px;
    margin-bottom: 8px;
    font-weight: bold;
}

.main-header .subtitle {
    font-size: 18px;
    margin-bottom: 15px;
    opacity: 0.9;
}

.header-info {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
    font-size: 16px;
    flex-wrap: wrap;
    gap: 20px;
}

.revision-info {
    font-size: 12px;
    margin-top: 10px;
    opacity: 0.8;
}

/* === SEZIONI PRINCIPALI === */
.section-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    border-left: 4px solid #2a5298;
}

.section-title {
    color: #1e3c72;
    font-weight: 600;
    margin-bottom: 18px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e9ecef;
    font-size: 18px;
}

/* === CONTROLLI === */
.controls-section {
    background-color: #e9ecef;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.form-group {
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 13px;
}

.form-control, .form-select {
    border-radius: 6px;
    border: 2px solid #e9ecef;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #2a5298;
    box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
}

/* === PULSANTI === */
.btn {
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107, #ffb300);
    color: #212529;
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8, #20c997);
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* === TOTALI === */
.totals-section {
    display: flex;
    justify-content: space-around;
    margin-bottom: 25px;
    background: linear-gradient(135deg, #ffc107, #ffb300);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.total-item {
    text-align: center;
    color: #000;
}

.total-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
}

.total-label {
    font-size: 14px;
    font-weight: 500;
}

/* === LAYOUT PRINCIPALE - GRIGLIA FORNITORI === */
.suppliers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

/* === CARD FORNITORE === */
.supplier-card {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    transition: all 0.3s ease;
    position: relative;
}

.supplier-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.supplier-header {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    padding: 12px;
    margin: -15px -15px 15px -15px;
    border-radius: 8px 8px 0 0;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
}

.supplier-row {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
}

/* === CAMPI CALCOLATI === */
.calculated-field {
    background-color: #e7f3ff !important;
    border-color: #bee5eb !important;
    font-weight: 600;
    text-align: center;
}

.yield-result {
    background-color: #e8f5e8 !important;
    border-color: #28a745 !important;
    font-weight: 600;
    text-align: center;
}

/* === STILI BIO === */
.bio-indicator {
    background-color: #d4edda;
    color: #155724;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.bio-red-field {
    color: #dc3545 !important;
    font-weight: 600;
    border-color: #dc3545 !important;
}

.bio-black-field {
    color: #000000 !important;
    font-weight: 600;
    border-color: #495057 !important;
}

.bio-red-text {
    color: #dc3545 !important;
    font-weight: 600;
}

.bio-black-text {
    color: #000000 !important;
    font-weight: 600;
}

/* === COMBINAZIONI === */
.combination-section {
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
}

.combination-group {
    background-color: #e3f2fd;
    border: 2px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.combination-group-verde {
    background-color: #e8f5e9;
    border: 2px solid #4caf50;
}

.combination-group-azzurro {
    background-color: #e0f7fa;
    border: 2px solid #00bcd4;
}

.combination-group-viola {
    background-color: #f3e5f5;
    border: 2px solid #9c27b0;
}

.combination-result {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    font-weight: bold;
    color: #856404 !important;
}

.combination-details {
    font-size: 11px;
    color: #856404;
    margin-top: 5px;
    padding: 5px;
    background-color: #fff3cd;
    border-radius: 4px;
    border: 1px solid #ffc107;
}

/* === TRASFERIMENTI === */
.transfer-section {
    background-color: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 12px;
    margin-top: 10px;
}

.transfer-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.received-transfer {
    background-color: #d4edda !important;
    border: 2px solid #28a745 !important;
}

.transfer-details {
    font-size: 10px;
    color: #155724;
    margin-top: 5px;
    padding: 4px;
    background-color: rgba(40, 167, 69, 0.1);
    border-radius: 3px;
}

/* === DISTRIBUZIONE === */
.distribution-section {
    background-color: #f8f9fa;
    border: 2px solid #17a2b8;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
}

.distribution-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.remaining-qty {
    background-color: #e7f3ff;
    border: 2px solid #2a5298;
    padding: 6px;
    border-radius: 4px;
    font-weight: bold;
    text-align: center;
    color: #1e3c72;
    font-size: 12px;
}

.distribution-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 8px;
}

.distribution-dest {
    flex: 1;
    font-weight: 600;
    color: #17a2b8;
    font-size: 12px;
}

.distribution-qty {
    width: 80px;
}

/* === HIDDEN FIELDS === */
.hidden-field {
    display: none !important;
}

/* === SELECT2 CUSTOMIZATION === */
.select2-container {
    width: 100% !important;
}

.select2-container--default .select2-selection--multiple {
    border: 2px solid #e9ecef;
    border-radius: 6px;
    min-height: 42px;
    padding: 4px;
}

.select2-container--default.select2-container--focus .select2-selection--multiple {
    border-color: #2a5298;
    box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
}

/* === MODAL RESE === */
.yields-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none;
    z-index: 1000;
    overflow-y: auto;
}

.yields-content {
    position: relative;
    background-color: white;
    margin: 2% auto;
    padding: 25px;
    width: 95%;
    max-width: 1400px;
    min-height: 80%;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.yields-header {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-yields {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close-yields:hover {
    color: #f0f0f0;
}

.yields-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 12px;
}

.yields-table th {
    background-color: #1e3c72;
    color: white;
    padding: 10px 6px;
    text-align: center;
    font-weight: 600;
    border: 1px solid #dee2e6;
}

.yields-table td {
    padding: 6px;
    text-align: center;
    border: 1px solid #dee2e6;
    vertical-align: middle;
}

.yields-table td:first-child {
    background-color: #f8f9fa;
    font-weight: 600;
    width: 120px;
}

.yields-table input[type="number"] {
    width: 60px;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 3px;
    text-align: center;
    font-size: 11px;
}

.yields-section {
    margin-bottom: 25px;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #2a5298;
}

.agrume-display {
    background-color: #e7f3ff;
    border: 2px solid #2a5298;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
}

/* === STILI STAMPA MIGLIORATI === */
@media print {
    @page {
        margin: 8mm;
        size: A4 landscape;
    }
    
    body {
        background-color: white !important;
        padding: 0 !important;
        font-size: 10px !important;
        line-height: 1.2 !important;
        color: #000 !important;
    }
    
    /* Nascondi elementi non necessari per la stampa */
    .controls-section,
    .combination-section,
    .btn,
    .no-print,
    button,
    .transfer-section,
    .distribution-section {
        display: none !important;
    }
    
    /* Header ottimizzato per stampa */
    .main-header {
        background: white !important;
        color: #000 !important;
        border: 2px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 8mm !important;
        padding: 15px !important;
    }
    
    .main-header h1 {
        font-size: 18px !important;
        margin-bottom: 5px !important;
    }
    
    .main-header .subtitle {
        font-size: 14px !important;
        margin-bottom: 8px !important;
    }
    
    .header-info {
        font-size: 12px !important;
        gap: 15px !important;
    }
    
    /* Totali ottimizzati */
    .totals-section {
        background: white !important;
        border: 2px solid #000 !important;
        margin-bottom: 6mm !important;
        padding: 12px !important;
        page-break-inside: avoid;
    }
    
    .total-value {
        font-size: 16px !important;
        color: #000 !important;
    }
    
    .total-label {
        font-size: 11px !important;
        color: #000 !important;
    }
    
    /* Griglia fornitori per stampa */
    .suppliers-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6mm !important;
        margin-bottom: 0 !important;
    }
    
    /* Card fornitori ottimizzate */
    .supplier-card {
        border: 2px solid #000 !important;
        background: white !important;
        box-shadow: none !important;
        page-break-inside: avoid;
        margin-bottom: 4mm !important;
        padding: 8px !important;
    }
    
    .supplier-header {
        background: #f0f0f0 !important;
        color: #000 !important;
        border: 1px solid #000 !important;
        margin: -8px -8px 8px -8px !important;
        padding: 8px !important;
        font-size: 12px !important;
    }
    
    .supplier-row {
        background: white !important;
        border: 1px solid #ccc !important;
        padding: 8px !important;
        margin-bottom: 6px !important;
    }
    
    /* Campi form per stampa */
    .form-control,
    .form-select,
    .calculated-field,
    .yield-result {
        border: 1px solid #000 !important;
        background: white !important;
        color: #000 !important;
        padding: 2px 4px !important;
        font-size: 9px !important;
        font-weight: bold !important;
    }
    
    .calculated-field {
        background: #f0f0f0 !important;
    }
    
    .yield-result {
        background: #e8f5e8 !important;
    }
    
    .form-label {
        font-size: 8px !important;
        font-weight: bold !important;
        color: #000 !important;
        margin-bottom: 2px !important;
    }
    
    /* Bio styles per stampa */
    .bio-red-field {
        background: #ffebee !important;
        color: #000 !important;
        border-color: #000 !important;
    }
    
    .bio-black-field {
        background: white !important;
        color: #000 !important;
        border-color: #000 !important;
    }
    
    /* Combinazioni per stampa */
    .combination-result {
        background: #fff3cd !important;
        border: 2px solid #000 !important;
        color: #000 !important;
    }
    
    .combination-details {
        background: white !important;
        border: 1px solid #000 !important;
        color: #000 !important;
        font-size: 7px !important;
        padding: 2px !important;
    }
    
    /* Responsive per stampa */
    .row {
        margin: 0 !important;
    }
    
    .col-md-3, .col-md-4, .col-md-6 {
        width: 100% !important;
        padding: 0 !important;
        margin-bottom: 3px !important;
    }
    
    /* Sezioni specifiche per stampa */
    .section-card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 4mm !important;
        padding: 6px !important;
        page-break-inside: avoid;
    }
    
    .section-title {
        font-size: 12px !important;
        color: #000 !important;
        border-bottom: 1px solid #000 !important;
        margin-bottom: 8px !important;
        padding-bottom: 4px !important;
    }
    
    /* Tabelle per stampa */
    .table {
        border-collapse: collapse !important;
        font-size: 8px !important;
    }
    
    .table th {
        background: #f0f0f0 !important;
        color: #000 !important;
        border: 1px solid #000 !important;
        padding: 4px !important;
    }
    
    .table td {
        border: 1px solid #000 !important;
        padding: 3px !important;
    }
    
    /* Layout specifico per stampa */
    .print-summary {
        page-break-before: always;
        margin-top: 10mm;
    }
    
    .print-page-break {
        page-break-after: always;
    }
    
    /* Footer stampa */
    .print-footer {
        position: fixed;
        bottom: 5mm;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 8px;
        color: #666;
    }
}

/* === MEDIA QUERIES === */
@media (max-width: 768px) {
    .suppliers-grid {
        grid-template-columns: 1fr;
    }
    
    .header-info {
        flex-direction: column;
        gap: 10px;
    }
    
    .totals-section {
        flex-direction: column;
        gap: 15px;
    }
    
    .controls-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .form-group {
        min-width: auto;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .main-header {
        padding: 15px;
    }
    
    .main-header h1 {
        font-size: 22px;
    }
    
    .section-card {
        padding: 15px;
    }
    
    .supplier-card {
        padding: 12px;
    }
}

/* === ANIMAZIONI === */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.supplier-card {
    animation: fadeIn 0.3s ease-out;
}

/* === UTILITIES === */
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-left { text-align: left; }
.font-weight-bold { font-weight: bold; }
.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: 5px; }
.mb-2 { margin-bottom: 10px; }
.mb-3 { margin-bottom: 15px; }
.mt-1 { margin-top: 5px; }
.mt-2 { margin-top: 10px; }
.mt-3 { margin-top: 15px; }

/* === STATO SALVATAGGIO === */
.save-status {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    display: none;
    animation: slideIn 0.3s ease-out;
}

.save-status.error {
    background: #dc3545;
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}
</style>
</head>

<body>
<div class="container-fluid">
    <!-- Header principale -->
    <div class="main-header">
        <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
        <h4 class="subtitle">Sistema di Gestione Produzione - Simone Gatto</h4>
        <div class="header-info">
            <div><strong>Data:</strong> <span id="current-date"></span></div>
            <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
            <div><strong>Fornitori:</strong> <span id="fornitori-count">0</span></div>
        </div>
        <div class="revision-info">
            Ultima revisione: <span id="last-revision"></span>
        </div>
    </div>

    <!-- Status salvataggio -->
    <div id="save-status" class="save-status">
        <span id="save-message"></span>
    </div>

    <!-- Sezione controlli -->
    <div class="controls-section no-print">
        <div class="form-group">
            <label for="tipo-agrume-giornaliero" class="form-label">Tipo di Agrume</label>
            <select class="form-select" id="tipo-agrume-giornaliero" required>
                <option value="">Seleziona il tipo di agrume</option>
                <option value="LIMONE">Limone</option>
                <option value="ARANCIA">Arancia</option>
                <option value="MANDARINO">Mandarino</option>
                <option value="POMPELMO">Pompelmo</option>
                <option value="BERGAMOTTO">Bergamotto</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
            <input type="date" class="form-control" id="data-lavorazione" required>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
                <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
            </button>
            <button type="button" class="btn btn-info" id="rese-button">
                <i class="bi bi-bar-chart-line-fill"></i> Rese
            </button>
            <button type="button" class="btn btn-success" id="salva-dati">
                <i class="bi bi-save"></i> Salva
            </button>
            <button type="button" class="btn btn-warning" id="carica-dati">
                <i class="bi bi-upload"></i> Carica
            </button>
            <button type="button" class="btn btn-warning" onclick="window.print()">
                <i class="bi bi-printer"></i> Stampa
            </button>
            <button type="button" class="btn btn-danger" id="reset-programma">
                <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
        </div>
    </div>

    <!-- Sezione Totali -->
    <div class="totals-section">
        <div class="total-item">
            <div class="total-value" id="entrata-giornaliera">0</div>
            <div class="total-label">Kg Entrata Totale</div>
        </div>
        <div class="total-item">
            <div class="total-value" id="trasformata-totale">0</div>
            <div class="total-label">Kg Trasformati</div>
        </div>
        <div class="total-item">
            <div class="total-value" id="giacenza-totale">0</div>
            <div class="total-label">Kg Giacenza</div>
        </div>
        <div class="total-item">
            <div class="total-value" id="succo-prima-totale">0</div>
            <div class="total-label">Kg Succo 1ª</div>
        </div>
        <div class="total-item">
            <div class="total-value" id="succo-seconda-totale">0</div>
            <div class="total-label">Kg Succo 2ª</div>
        </div>
        <div class="total-item">
            <div class="total-value" id="torchiato-totale">0</div>
            <div class="total-label">Kg Torchiato</div>
        </div>
    </div>

    <!-- Sezione Combinazioni -->
    <div id="combinazioni-section" class="combination-section hidden-field no-print">
        <h3 class="section-title"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
        
        <!-- Combinazione Verde -->
        <div class="combination-group combination-group-verde">
            <h5><i class="bi bi-diagram-2"></i> Combinazione Verde - Succo 1ª</h5>
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label">Seleziona Fornitori da Combinare (fino a 3 fornitori)</label>
                    <select class="form-select" id="combinazione-fornitori-verde">
                        <option value="">Seleziona combinazione Verde</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <br>
                    <button type="button" class="btn btn-success me-2" id="applica-combinazione-verde">
                        <i class="bi bi-check-circle"></i> Applica Verde
                    </button>
                    <button type="button" class="btn btn-warning" id="reset-combinazione-verde">
                        <i class="bi bi-x-circle"></i> Reset Verde
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Combinazione Azzurro -->
        <div class="combination-group combination-group-azzurro">
            <h5><i class="bi bi-diagram-3"></i> Combinazione Azzurro - Succo 1ª</h5>
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label">Seleziona Fornitori da Combinare (fino a 3 fornitori)</label>
                    <select class="form-select" id="combinazione-fornitori-azzurro">
                        <option value="">Seleziona combinazione Azzurro</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <br>
                    <button type="button" class="btn btn-info me-2" id="applica-combinazione-azzurro">
                        <i class="bi bi-check-circle"></i> Applica Azzurro
                    </button>
                    <button type="button" class="btn btn-warning" id="reset-combinazione-azzurro">
                        <i class="bi bi-x-circle"></i> Reset Azzurro
                    </button>
                </div>
            </div>
        </div>

        <!-- Combinazione Viola -->
        <div class="combination-group combination-group-viola">
            <h5><i class="bi bi-diagram-3"></i> Combinazione Viola - Succo 1ª</h5>
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label">Seleziona Fornitori da Combinare (fino a 3 fornitori)</label>
                    <select class="form-select" id="combinazione-fornitori-viola">
                        <option value="">Seleziona combinazione Viola</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <br>
                    <button type="button" class="btn" style="background: #9c27b0; color: white;" id="applica-combinazione-viola">
                        <i class="bi bi-check-circle"></i> Applica Viola
                    </button>
                    <button type="button" class="btn btn-warning" id="reset-combinazione-viola">
                        <i class="bi bi-x-circle"></i> Reset Viola
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Griglia Fornitori -->
    <div class="suppliers-grid" id="fornitori-container">
        <!-- I fornitori verranno aggiunti dinamicamente qui -->
    </div>

    <!-- Sezione Riepilogo per stampa -->
    <div class="print-summary section-card">
        <h3 class="section-title">Riepilogo Produzioni</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>Succo 2ª</h5>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Totale Succo 2ª:</strong></td>
                            <td class="text-end"><span id="riepilogo-seconda">0</span> kg</td>
                        </tr>
                        <tr>
                            <td><strong>Destinazione:</strong></td>
                            <td class="text-end" id="dest-seconda">NAT IN TINI</td>
                        </tr>
                        <tr>
                            <td><strong>Tenore Polpa:</strong></td>
                            <td class="text-end" id="polpa-seconda">&lt;1%</td>
                        </tr>
                        <tr>
                            <td><strong>°BX:</strong></td>
                            <td class="text-end" id="brix-seconda">NAT</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h5>Torchiato</h5>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Totale Torchiato:</strong></td>
                            <td class="text-end"><span id="riepilogo-torchiato">0</span> kg</td>
                        </tr>
                        <tr>
                            <td><strong>Destinazione:</strong></td>
                            <td class="text-end" id="dest-torchiato">CONCENTRATO</td>
                        </tr>
                        <tr>
                            <td><strong>Tenore Polpa:</strong></td>
                            <td class="text-end" id="polpa-torchiato">&lt;1%</td>
                        </tr>
                        <tr>
                            <td><strong>°BX:</strong></td>
                            <td class="text-end" id="brix-torchiato">45</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Rese -->
<div id="yields-modal" class="yields-modal">
    <div class="yields-content">
        <div class="yields-header">
            <h2><i class="bi bi-bar-chart-line-fill"></i> Gestione Rese per Agrume</h2>
            <span class="close-yields">&times;</span>
        </div>
        
        <div class="agrume-display">
            <h4 id="agrume-selected">Nessun agrume selezionato</h4>
        </div>
        
        <div class="yields-section">
            <h5><i class="bi bi-droplet"></i> Rese Succo 1ª (%)</h5>
            <table class="yields-table">
                <thead>
                    <tr>
                        <th>Resa</th>
                        <th>Gen</th>
                        <th>Feb</th>
                        <th>Mar</th>
                        <th>Apr</th>
                        <th>Mag</th>
                        <th>Giu</th>
                        <th>Lug</th>
                        <th>Ago</th>
                        <th>Set</th>
                        <th>Ott</th>
                        <th>Nov</th>
                        <th>Dic</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Succo 1ª (%)</strong></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="1" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="2" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="3" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="4" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="5" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="6" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="7" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="8" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="9" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="10" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="11" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="prima" data-month="12" min="0" max="100" step="0.1"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="yields-section">
            <h5><i class="bi bi-droplet"></i> Rese Succo 2ª (%)</h5>
            <table class="yields-table">
                <thead>
                    <tr>
                        <th>Resa</th>
                        <th>Gen</th>
                        <th>Feb</th>
                        <th>Mar</th>
                        <th>Apr</th>
                        <th>Mag</th>
                        <th>Giu</th>
                        <th>Lug</th>
                        <th>Ago</th>
                        <th>Set</th>
                        <th>Ott</th>
                        <th>Nov</th>
                        <th>Dic</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Succo 2ª (%)</strong></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="1" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="2" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="3" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="4" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="5" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="6" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="7" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="8" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="9" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="10" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="11" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="seconda" data-month="12" min="0" max="100" step="0.1"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="yields-section">
            <h5><i class="bi bi-droplet"></i> Rese Torchiato (%)</h5>
            <table class="yields-table">
                <thead>
                    <tr>
                        <th>Resa</th>
                        <th>Gen</th>
                        <th>Feb</th>
                        <th>Mar</th>
                        <th>Apr</th>
                        <th>Mag</th>
                        <th>Giu</th>
                        <th>Lug</th>
                        <th>Ago</th>
                        <th>Set</th>
                        <th>Ott</th>
                        <th>Nov</th>
                        <th>Dic</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Torchiato (%)</strong></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="1" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="2" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="3" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="4" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="5" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="6" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="7" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="8" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="9" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="10" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="11" min="0" max="100" step="0.1"></td>
                        <td><input type="number" class="yield-input" data-type="torchiato" data-month="12" min="0" max="100" step="0.1"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-4">
            <button type="button" class="btn btn-success btn-lg me-3" id="salva-rese">
                <i class="bi bi-save"></i> Salva Rese
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg" id="reset-rese">
                <i class="bi bi-arrow-clockwise"></i> Reset Valori
            </button>
        </div>
    </div>
</div>

<!-- Input file nascosto -->
<input type="file" id="file-input" accept=".json" style="display: none;">

<script>
$(document).ready(function() {
    // Variabili globali
    let supplierCount = 0;
    let yieldsData = {};
    let transferData = {};
    let combinationData = {
        verde: { indexes: [], details: [], totalCombination: 0 },
        azzurro: { indexes: [], details: [], totalCombination: 0 },
        viola: { indexes: [], details: [], totalCombination: 0 }
    };

    // Rese predefinite per tipo di agrume
    const defaultYields = {
        'LIMONE': { prima: 32, seconda: 5, torchiato: 6 },
        'ARANCIA': { prima: 35, seconda: 12, torchiato: 6 },
        'MANDARINO': { prima: 42, seconda: 10, torchiato: 4 },
        'POMPELMO': { prima: 30, seconda: 15, torchiato: 6 },
        'BERGAMOTTO': { prima: 30, seconda: 8, torchiato: 3 }
    };

    // Varietà per ogni tipo di agrume
    const varietyOptions = {
        'LIMONE': [
            { value: 'VERDELLO', text: 'Verdello' },
            { value: 'FEMMINELLO', text: 'Femminello' },
            { value: 'INTERDONATO', text: 'Interdonato' },
            { value: 'BIANCHETTO', text: 'Bianchetto' },
            { value: 'MONACHELLO', text: 'Monachello' },
            { value: 'VARIE', text: 'Varie' },
            { value: 'ALTRO', text: 'Altro (specifica quale)' }
        ],
        'MANDARINO': [
            { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
            { value: 'AVANA', text: 'Avana' },
            { value: 'CLEMENTINO', text: 'Clementino' },
            { value: 'VARIE', text: 'Varie' },
            { value: 'ALTRO', text: 'Altro (specifica quale)' }
        ],
        'ARANCIA': [
            { value: 'BIONDA', text: 'Bionda' },
            { value: 'MORO', text: 'Moro' },
            { value: 'SANGUINELLA', text: 'Sanguinella' },
            { value: 'TAROCCO', text: 'Tarocco' },
            { value: 'VARIE', text: 'Varie' },
            { value: 'ALTRO', text: 'Altro (specifica quale)' }
        ],
        'BERGAMOTTO': [
            { value: 'FEMMINELLO', text: 'Femminello' },
            { value: 'CASTAGNARO', text: 'Castagnaro' },
            { value: 'VARIE', text: 'Varie' },
            { value: 'ALTRO', text: 'Altro (specifica quale)' }
        ],
        'POMPELMO': [
            { value: 'GIALLO', text: 'Giallo' },
            { value: 'ROSA', text: 'Rosa' },
            { value: 'VARIE', text: 'Varie' },
            { value: 'ALTRO', text: 'Altro (specifica quale)' }
        ]
    };

    // Inizializzazione
    function initApp() {
        const today = new Date();
        const formatted = today.toLocaleDateString('it-IT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        $('#current-date').text(formatted);
        $('#data-lavorazione').val(today.toISOString().split('T')[0]);
        
        updateLastRevision();
        updateCounts();
    }

    function updateLastRevision() {
        const now = new Date();
        const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
        $('#last-revision').text(lastRevision);
    }

    function updateCounts() {
        const count = $('.supplier-row').length;
        $('#fornitori-count').text(count);
    }

    // Template fornitore
    function getSupplierTemplate(index) {
        const agrume = $('#tipo-agrume-giornaliero').val();
        let varietyOptionsHtml = '<option value="">Seleziona varietà</option>';
        
        if (agrume && varietyOptions[agrume]) {
            varietyOptions[agrume].forEach(function(variety) {
                varietyOptionsHtml += `<option value="${variety.value}">${variety.text}</option>`;
            });
        }

        return `
        <div class="supplier-card supplier-row" data-supplier-index="${index}">
            <div class="supplier-header">
                <span class="supplier-number">Fornitore ${index}</span>
                <button type="button" class="btn btn-outline-danger btn-sm float-end rimuovi-fornitore">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="row g-3">
                <!-- Dati base fornitore -->
                <div class="col-md-3">
                    <label class="form-label">Nome Fornitore</label>
                    <select class="form-select nome-fornitore" required>
                        <option value="">Seleziona fornitore</option>
                        <option value="RESTUCCIA">RESTUCCIA</option>
                        <option value="CI">CI</option>
                        <option value="ARCO">ARCO</option>
                        <option value="GIOVINAZZO">GIOVINAZZO</option>
                        <option value="AZ.T.C.">AZ.T.C.</option>
                        <option value="M.B.T.F.">M.B.T.F.</option>
                        <option value="VASTA">VASTA</option>
                        <option value="APAL">APAL</option>
                        <option value="GEIMA">GEIMA</option>
                        <option value="UNIONBERG">UNIONBERG</option>
                        <option value="ALTRO">ALTRO</option>
                    </select>
                    <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Quantità in Entrata (kg)</label>
                    <input type="number" class="form-control quantita-fornitore" min="0" required>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Quantità trasformata (kg)</label>
                    <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Giacenza (kg)</label>
                    <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Certificazione Prodotto</label>
                    <select class="form-select certificazione-prodotto" required>
                        <option value="">Seleziona certificazione</option>
                        <option value="BIO EU">BIO EU</option>
                        <option value="BIO DEM">BIO DEM</option>
                        <option value="BIO NTD">BIO NTD</option>
                        <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                        <option value="TRACCIATO">TRACCIATO</option>
                        <option value="IGP">IGP</option>
                        <option value="CONVENZIONALE">CONVENZIONALE</option>
                        <option value="ALTRO">ALTRO</option>
                    </select>
                    <input type="text" class="form-control mt-2 altra-certificazione hidden-field" placeholder="Specifica altra certificazione">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Varietà</label>
                    <select class="form-select varieta-prodotto" required>
                        ${varietyOptionsHtml}
                    </select>
                    <input type="text" class="form-control mt-2 altra-varieta hidden-field" placeholder="Specifica altra varietà">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Linea di Trasformazione</label>
                    <select class="form-select linea-trasformazione" required>
                        <option value="">Seleziona linea</option>
                        <option value="BOE/1100">BOE/1100</option>
                        <option value="GOE INT/POLY">GOE INT/POLY</option>
                        <option value="GOE EST/POLY">GOE EST/POLY</option>
                        <option value="GOE EST/400">GOE EST/400</option>
                        <option value="B/SF">B/SF</option>
                        <option value="TORCHI FASO">TORCHI FASO</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Portata Impianto (kg/h)</label>
                    <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Orario Inizio Lavorazione</label>
                    <input type="time" class="form-control orario-inizio" required>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Orario Fine Lavorazione</label>
                    <div class="form-control calculated-field orario-fine-display">--:--</div>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Durata Lavorazione</label>
                    <input type="text" class="form-control calculated-field durata-lavorazione" readonly>
                </div>
            </div>
            
            <!-- Sezione Rese -->
            <div class="mt-4">
                <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni</h6>
                
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Resa Succo 1ª (%)</label>
                        <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" placeholder="Auto">
                    </div>
                    
                    <div class="col-md-4 seconda-section">
                        <label class="form-label">Resa Succo 2ª (%)</label>
                        <input type="number" class="form-control resa-seconda" step="0.1" min="0" max="100" placeholder="Auto">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Resa Torchiato (%)</label>
                        <input type="number" class="form-control resa-torchiato" step="0.1" min="0" max="100" placeholder="Auto">
                    </div>
                </div>
                
                <!-- Risultati calcolo rese -->
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Quantità Succo 1ª (kg)</label>
                        <input type="number" class="form-control yield-result quantita-prima" readonly>
                        <div class="transfer-details hidden-field"></div>
                        <div class="combination-details hidden-field"></div>
                    </div>
                    
                    <div class="col-md-4 seconda-section">
                        <label class="form-label">Quantità Succo 2ª (kg)</label>
                        <input type="number" class="form-control yield-result quantita-seconda" readonly>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Quantità Torchiato (kg)</label>
                        <input type="number" class="form-control yield-result quantita-torchiato" readonly>
                    </div>
                </div>
                
                <!-- Destinazioni -->
                <div class="row g-3 mt-3">
                    <div class="col-md-4">
                        <label class="form-label destinazione-prima-label">Destinazione Succo 1ª</label>
                        <select class="form-select destinazione-prima" multiple>
                            <option value="NAT IN TINI">NAT IN TINI</option>
                            <option value="PET 100">PET 100</option>
                            <option value="PET 200">PET 200</option>
                            <option value="PET 480">PET 480</option>
                            <option value="ACMA">ACMA</option>
                            <option value="REX">REX</option>
                            <option value="GOGLIO">GOGLIO</option>
                            <option value="VASCHETTE">VASCHETTE</option>
                            <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                            <option value="LATTE">LATTE</option>
                            <option value="F.F.">F.F.</option>
                            <option value="F.T.C">F.T.C</option>
                            <option value="FBL">FBL</option>
                            <option value="BIC">BIC</option>
                            <option value="CISTERNA P">CISTERNA P</option>
                            <option value="CISTERNA EF">CISTERNA EF</option>
                            <option value="CISTERNA VK">CISTERNA VK</option>
                            <option value="CISTERNA GS">CISTERNA GS</option>
                            <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                            <option value="CONCENTRATO">CONCENTRATO</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                        
                        <!-- Distribuzione quantità -->
                        <div class="distribution-section mt-3 hidden-field">
                            <div class="distribution-header">
                                <h6><i class="bi bi-distribute-horizontal"></i> Distribuzione Quantità</h6>
                                <div class="remaining-qty">Rimanente: <span class="remaining-value">0</span> kg</div>
                            </div>
                            <div class="distribution-container">
                                <!-- Le righe di distribuzione verranno aggiunte dinamicamente -->
                            </div>
                            <!-- Sezione trasferimento -->
                            <div class="transfer-section hidden-field">
                                <div class="transfer-row">
                                    <label class="form-label">Invia esubero a:</label>
                                    <select class="form-select transfer-destination">
                                        <option value="">Seleziona fornitore</option>
                                    </select>
                                    <input type="number" class="form-control transfer-qty" placeholder="kg" min="0" step="0.1">
                                    <button type="button" class="btn btn-sm btn-success execute-transfer">
                                        <i class="bi bi-arrow-right"></i> Trasferisci
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 seconda-section">
                        <label class="form-label">Destinazione Succo 2ª</label>
                        <select class="form-select destinazione-seconda">
                            <option value="">Seleziona destinazione</option>
                            <option value="NAT IN TINI" selected>NAT IN TINI</option>
                            <option value="CONCENTRATO">CONCENTRATO</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Destinazione Torchiato</label>
                        <select class="form-select destinazione-torchiato">
                            <option value="">Seleziona destinazione</option>
                            <option value="NAT IN TINI">NAT IN TINI</option>
                            <option value="F.F.">F.F.</option>
                            <option value="F.T.C">F.T.C</option>
                            <option value="FBL">FBL</option>
                            <option value="BIC">BIC</option>
                            <option value="CONCENTRATO" selected>CONCENTRATO</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                    </div>
                </div>
                
                <!-- Caratteristiche prodotti -->
                <div class="row g-3 mt-3">
                    <div class="col-md-4">
                        <label class="form-label">Tenore Polpa Succo 1ª</label>
                        <select class="form-select tenore-polpa-prima">
                            <option value="STANDARD">STANDARD</option>
                            <option value="LIMPIDO">LIMPIDO</option>
                            <option value="SEMICLEAR">SEMICLEAR</option>
                            <option value="<1%"><1%</option>
                            <option value="2%">2%</option>
                            <option value="3%">3%</option>
                            <option value="6%">6%</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-tenore-prima hidden-field" placeholder="Specifica altro tenore">
                        
                        <label class="form-label mt-2">Brix</label>
                        <select class="form-select brix-prima">
                            <option value="NAT">NAT</option>
                            <option value="20">20</option>
                            <option value="32">32</option>
                            <option value="40">40</option>
                            <option value="41">41</option>
                            <option value="45">45</option>
                            <option value="55">55</option>
                            <option value="58">58</option>
                            <option value="60">60</option>
                            <option value="63.5">63.5</option>
                            <option value="65">65</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-brix-prima hidden-field" placeholder="Specifica altro Brix">
                        
                        <label class="form-label mt-2">Biologico</label>
                        <select class="form-select bio-prima">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                            <option value="DECLASSATO">DECLASSATO</option>
                        </select>
                        
                        <label class="form-label mt-2">Pastorizzato</label>
                        <select class="form-select pastorizzato-prima">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Conservato</label>
                        <select class="form-select conservato-prima">
                            <option value="SI">SI</option>
                            <option value="NO" selected>NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Note</label>
                        <textarea class="form-control note-prima" placeholder="Note succo 1ª" rows="2"></textarea>
                    </div>
                    
                    <div class="col-md-4 seconda-section">
                        <label class="form-label">Tenore Polpa Succo 2ª</label>
                        <select class="form-select tenore-polpa-seconda">
                            <option value="STANDARD">STANDARD</option>
                            <option value="LIMPIDO">LIMPIDO</option>
                            <option value="SEMICLEAR">SEMICLEAR</option>
                            <option value="<1%" selected><1%</option>
                            <option value="2%">2%</option>
                            <option value="3%">3%</option>
                            <option value="6%">6%</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-tenore-seconda hidden-field" placeholder="Specifica altro tenore">
                        
                        <label class="form-label mt-2">Brix</label>
                        <select class="form-select brix-seconda">
                            <option value="NAT">NAT</option>
                            <option value="20">20</option>
                            <option value="32">32</option>
                            <option value="40">40</option>
                            <option value="41">41</option>
                            <option value="45">45</option>
                            <option value="55">55</option>
                            <option value="58">58</option>
                            <option value="60">60</option>
                            <option value="63.5">63.5</option>
                            <option value="65">65</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-brix-seconda hidden-field" placeholder="Specifica altro Brix">
                        
                        <label class="form-label mt-2">Pastorizzato</label>
                        <select class="form-select pastorizzato-seconda">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Conservato</label>
                        <select class="form-select conservato-seconda">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Note</label>
                        <textarea class="form-control note-seconda" placeholder="Note succo 2ª" rows="2">SERB. ESTERNI</textarea>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Tenore Polpa Torchiato</label>
                        <select class="form-select tenore-polpa-torchiato">
                            <option value="STANDARD">STANDARD</option>
                            <option value="LIMPIDO">LIMPIDO</option>
                            <option value="SEMICLEAR">SEMICLEAR</option>
                            <option value="<1%" selected><1%</option>
                            <option value="2%">2%</option>
                            <option value="3%">3%</option>
                            <option value="6%">6%</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-tenore-torchiato hidden-field" placeholder="Specifica altro tenore">
                        
                        <label class="form-label mt-2">Brix</label>
                        <select class="form-select brix-torchiato">
                            <option value="NAT">NAT</option>
                            <option value="20">20</option>
                            <option value="32">32</option>
                            <option value="40">40</option>
                            <option value="41">41</option>
                            <option value="45" selected>45</option>
                            <option value="55">55</option>
                            <option value="58">58</option>
                            <option value="60">60</option>
                            <option value="63.5">63.5</option>
                            <option value="65">65</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                        <input type="text" class="form-control mt-2 altro-brix-torchiato hidden-field" placeholder="Specifica altro Brix">
                        
                        <label class="form-label mt-2">Pastorizzato</label>
                        <select class="form-select pastorizzato-torchiato">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Conservato</label>
                        <select class="form-select conservato-torchiato">
                            <option value="SI">SI</option>
                            <option value="NO" selected>NO</option>
                        </select>
                        
                        <label class="form-label mt-2">Note</label>
                        <textarea class="form-control note-torchiato" placeholder="Note torchiato" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Aggiunta nuovo fornitore
    function addSupplier() {
        if (!$('#tipo-agrume-giornaliero').val()) {
            alert('Seleziona prima il tipo di agrume');
            return;
        }

        supplierCount++;
        const template = getSupplierTemplate(supplierCount);
        const newSupplier = $(template);
        
        // Applica rese automatiche
        const agrume = $('#tipo-agrume-giornaliero').val();
        if (agrume && defaultYields[agrume]) {
            const yields = defaultYields[agrume];
            newSupplier.find('.resa-prima').val(yields.prima);
            newSupplier.find('.resa-seconda').val(yields.seconda);
            newSupplier.find('.resa-torchiato').val(yields.torchiato);
        }
        
        $('#fornitori-container').append(newSupplier);
        
        // Inizializza Select2 per destinazioni multiple
        newSupplier.find('.destinazione-prima').select2({
            placeholder: "Seleziona fino a 3 destinazioni",
            maximumSelectionLength: 3,
            language: {
                maximumSelected: function() {
                    return "Puoi selezionare massimo 3 destinazioni";
                }
            }
        });
        
        // Nascondi sezione succo 2ª se non è BOE/1100
        newSupplier.find('.seconda-section').addClass('hidden-field');
        
        attachSupplierEvents(newSupplier);
        updateCombinazioniOptions();
        toggleCombinazioniSection();
        updateCounts();
    }

    // Eventi per ogni fornitore
    function attachSupplierEvents(supplierElement) {
        const index = supplierElement.data('supplier-index');
        
        // Eventi campi
        supplierElement.find('.nome-fornitore').change(function() {
            const altroField = supplierElement.find('.altro-fornitore');
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
            updateSupplierHeader(supplierElement);
            updateCombinazioniOptions();
            updateTransferOptions();
        });

        supplierElement.find('.altro-fornitore').on('input', function() {
            updateSupplierHeader(supplierElement);
            updateCombinazioniOptions();
            updateTransferOptions();
        });

        supplierElement.find('.certificazione-prodotto').change(function() {
            const altroField = supplierElement.find('.altra-certificazione');
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
            updateBioStyles(supplierElement);
            updateCombinazioniOptions();
        });

        supplierElement.find('.varieta-prodotto').change(function() {
            const altroField = supplierElement.find('.altra-varieta');
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
        });

        supplierElement.find('.linea-trasformazione').change(function() {
            toggleSecondaSection(supplierElement);
            updateBioStyles(supplierElement);
            updateCombinazioniOptions();
        });

        supplierElement.find('.destinazione-prima').on('change', function() {
            const selectedValues = $(this).val() || [];
            const altroField = supplierElement.find('.altra-destinazione');
            
            if (selectedValues.includes('ALTRO')) {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
            
            updateDistributionSection(supplierElement);
        });

        supplierElement.find('.destinazione-seconda, .destinazione-torchiato').change(function() {
            const altroField = $(this).siblings('.altra-destinazione');
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
        });

        // Eventi campi altro per caratteristiche
        supplierElement.find('.tenore-polpa-prima, .tenore-polpa-seconda, .tenore-polpa-torchiato').change(function() {
            const altroField = $(this).hasClass('tenore-polpa-prima') ? supplierElement.find('.altro-tenore-prima') :
                             $(this).hasClass('tenore-polpa-seconda') ? supplierElement.find('.altro-tenore-seconda') :
                             supplierElement.find('.altro-tenore-torchiato');
            
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
        });

        supplierElement.find('.brix-prima, .brix-seconda, .brix-torchiato').change(function() {
            const altroField = $(this).hasClass('brix-prima') ? supplierElement.find('.altro-brix-prima') :
                             $(this).hasClass('brix-seconda') ? supplierElement.find('.altro-brix-seconda') :
                             supplierElement.find('.altro-brix-torchiato');
            
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
        });

        supplierElement.find('.bio-prima').change(function() {
            updateDestinationColors(supplierElement);
        });

        // Calcoli automatici
        supplierElement.find('.quantita-fornitore, .quantita-trasformata, .portata-impianto, .orario-inizio, .resa-prima, .resa-seconda, .resa-torchiato').on('input change', function() {
            calculateEndTime(supplierElement);
            calculateGiacenza(supplierElement);
            calculateYieldQuantities(supplierElement);
            updateTotals();
            updateDistributionTotal(supplierElement);
        });

        // Trasferimento
        supplierElement.find('.execute-transfer').click(function() {
            executeTransfer(supplierElement);
        });

        // Rimozione fornitore
        supplierElement.find('.rimuovi-fornitore').click(function() {
            if (confirm('Sei sicuro di voler rimuovere questo fornitore?')) {
                const supplierIndex = supplierElement.data('supplier-index');
                
                // Rimuovi trasferimenti associati
                delete transferData[supplierIndex];
                Object.keys(transferData).forEach(key => {
                    transferData[key] = transferData[key].filter(transfer => 
                        transfer.fromSupplier !== supplierIndex
                    );
                });

                // Rimuovi dalle combinazioni
                ['verde', 'azzurro', 'viola'].forEach(color => {
                    const indexPos = combinationData[color].indexes.indexOf(supplierIndex);
                    if (indexPos > -1) {
                        combinationData[color].indexes.splice(indexPos, 1);
                        combinationData[color].details = combinationData[color].details.filter(d => d.supplierIndex !== supplierIndex);
                        combinationData[color].totalCombination = 0;
                    }
                });
                
                supplierElement.remove();
                updateTotals();
                updateCombinazioniOptions();
                toggleCombinazioniSection();
                renumberSuppliers();
                updateCounts();
            }
        });
    }

    // Aggiorna header fornitore
    function updateSupplierHeader(supplierElement) {
        const nome = supplierElement.find('.nome-fornitore').val();
        const altroNome = supplierElement.find('.altro-fornitore').val();
        const index = supplierElement.data('supplier-index');
        
        let displayName = nome === 'ALTRO' ? altroNome : nome;
        const headerText = displayName ? `Fornitore ${index} - ${displayName}` : `Fornitore ${index}`;
        
        supplierElement.find('.supplier-number').text(headerText);
    }

    // Gestione visibilità sezione succo 2ª
    function toggleSecondaSection(supplierElement) {
        const linea = supplierElement.find('.linea-trasformazione').val();
        const secondaSections = supplierElement.find('.seconda-section');
        
        if (linea === 'BOE/1100') {
            secondaSections.removeClass('hidden-field');
        } else {
            secondaSections.addClass('hidden-field');
            // Reset valori
            supplierElement.find('.resa-seconda, .quantita-seconda').val('');
            supplierElement.find('.destinazione-seconda').val('NAT IN TINI');
            supplierElement.find('.tenore-polpa-seconda').val('<1%');
            supplierElement.find('.brix-seconda').val('NAT');
            supplierElement.find('.pastorizzato-seconda').val('SI');
            supplierElement.find('.conservato-seconda').val('SI');
            supplierElement.find('.note-seconda').val('SERB. ESTERNI');
        }
    }

    // Aggiorna stili bio
    function updateBioStyles(supplierElement) {
        const certificazione = supplierElement.find('.certificazione-prodotto').val();
        const certificazioneField = supplierElement.find('.certificazione-prodotto');
        const varietaField = supplierElement.find('.varieta-prodotto');
        const lineaField = supplierElement.find('.linea-trasformazione');
        
        // Reset stili
        certificazioneField.removeClass('bio-red-field');
        varietaField.removeClass('bio-red-field');
        lineaField.removeClass('bio-red-field');
        
        // Applica stili bio
        if (['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione)) {
            certificazioneField.addClass('bio-red-field');
            varietaField.addClass('bio-red-field');
            lineaField.addClass('bio-red-field');
        }
        
        updateDestinationColors(supplierElement);
    }

    // Aggiorna colori destinazione
    function updateDestinationColors(supplierElement) {
        const certificazione = supplierElement.find('.certificazione-prodotto').val();
        const bioStatus = supplierElement.find('.bio-prima').val();
        const destinazionePrimaLabel = supplierElement.find('.destinazione-prima-label');
        
        // Reset stili
        destinazionePrimaLabel.removeClass('bio-red-text bio-black-text');
        
        if (['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione)) {
            if (bioStatus === 'DECLASSATO' || bioStatus === 'NO') {
                destinazionePrimaLabel.addClass('bio-black-text');
            } else {
                destinazionePrimaLabel.addClass('bio-red-text');
            }
        }
    }

    // Calcolo orario fine
    function calculateEndTime(supplierElement) {
        const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
        const portata = parseFloat(supplierElement.find('.portata-impianto').val()) || 0;
        const orarioInizio = supplierElement.find('.orario-inizio').val();
        
        if (quantitaTrasformata > 0 && portata > 0 && orarioInizio) {
            const durataTotaleMinuti = Math.round((quantitaTrasformata / portata) * 60);
            const ore = Math.floor(durataTotaleMinuti / 60);
            const minuti = durataTotaleMinuti % 60;
            
            const dataLavorazione = $('#data-lavorazione').val();
            if (!dataLavorazione) {
                supplierElement.find('.orario-fine-display').text('--:--');
                supplierElement.find('.durata-lavorazione').val('');
                return;
            }
            
            const [oraInizio, minutiInizio] = orarioInizio.split(':').map(n => parseInt(n));
            const dataInizio = new Date(dataLavorazione);
            dataInizio.setHours(oraInizio, minutiInizio, 0, 0);
            
            const dataFine = new Date(dataInizio.getTime() + durataTotaleMinuti * 60 * 1000);
            
            const oreFine = dataFine.getHours().toString().padStart(2, '0');
            const minutiFine = dataFine.getMinutes().toString().padStart(2, '0');
            let orarioFineDisplay = `${oreFine}:${minutiFine}`;
            
            if (dataFine.getDate() !== dataInizio.getDate()) {
                orarioFineDisplay += ' (g.succ.)';
            }
            
            supplierElement.find('.orario-fine-display').text(orarioFineDisplay);
            supplierElement.find('.durata-lavorazione').val(`${ore}h ${minuti}m`);
        } else {
            supplierElement.find('.orario-fine-display').text('--:--');
            supplierElement.find('.durata-lavorazione').val('');
        }
    }

    // Calcolo giacenza
    function calculateGiacenza(supplierElement) {
        const quantitaEntrata = parseFloat(supplierElement.find('.quantita-fornitore').val()) || 0;
        const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
        const giacenza = quantitaEntrata - quantitaTrasformata;
        
        supplierElement.find('.giacenza-fornitore').val(giacenza >= 0 ? giacenza : 0);
    }

    // Calcolo quantità prodotti
    function calculateYieldQuantities(supplierElement) {
        const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
        const resaPrima = parseFloat(supplierElement.find('.resa-prima').val()) || 0;
        const resaSeconda = parseFloat(supplierElement.find('.resa-seconda').val()) || 0;
        const resaTorchiato = parseFloat(supplierElement.find('.resa-torchiato').val()) || 0;
        const linea = supplierElement.find('.linea-trasformazione').val();
        
        if (quantitaTrasformata > 0) {
            // Calcola succo 1ª se non è un valore da combinazione
            const quantitaPrimaField = supplierElement.find('.quantita-prima');
            if (!quantitaPrimaField.hasClass('combination-result')) {
                const quantitaPrima = (quantitaTrasformata * resaPrima / 100).toFixed(1);
                quantitaPrimaField.val(quantitaPrima);
            }
            
            // Calcola succo 2ª solo per BOE/1100
            if (linea === 'BOE/1100' && resaSeconda > 0) {
                const quantitaSeconda = (quantitaTrasformata * resaSeconda / 100).toFixed(1);
                supplierElement.find('.quantita-seconda').val(quantitaSeconda);
            } else {
                supplierElement.find('.quantita-seconda').val('');
            }
            
            // Calcola torchiato
            if (resaTorchiato > 0) {
                const quantitaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                supplierElement.find('.quantita-torchiato').val(quantitaTorchiato);
            } else {
                supplierElement.find('.quantita-torchiato').val('');
            }
        } else {
            // Reset se non è combinazione
            const quantitaPrimaField = supplierElement.find('.quantita-prima');
            if (!quantitaPrimaField.hasClass('combination-result')) {
                quantitaPrimaField.val('');
            }
            supplierElement.find('.quantita-seconda').val('');
            supplierElement.find('.quantita-torchiato').val('');
        }
}

    // Gestione distribuzione quantità
    function updateDistributionSection(supplierElement) {
        const selectedDestinations = supplierElement.find('.destinazione-prima').val() || [];
        const distributionSection = supplierElement.find('.distribution-section');
        const distributionContainer = distributionSection.find('.distribution-container');
        
        if (selectedDestinations.length >= 1) {
            distributionSection.removeClass('hidden-field');
            distributionContainer.empty();
            
            selectedDestinations.forEach(dest => {
                const row = $(`
                    <div class="distribution-row">
                        <div class="distribution-dest">${dest}</div>
                        <input type="number" class="form-control distribution-qty" placeholder="kg" min="0" step="0.1" data-dest="${dest}">
                    </div>
                `);
                distributionContainer.append(row);
            });
            
            // Eventi per calcolo totale
            distributionContainer.find('.distribution-qty').on('input', function() {
                updateDistributionTotal(supplierElement);
            });
            
            updateTransferOptions();
            updateDistributionTotal(supplierElement);
        } else {
            distributionSection.addClass('hidden-field');
        }
    }

    // Aggiorna totale distribuzione
    function updateDistributionTotal(supplierElement) {
        let distributedTotal = 0;
        supplierElement.find('.distribution-qty').each(function() {
            const value = parseFloat($(this).val()) || 0;
            distributedTotal += value;
        });
        
        const quantitaPrima = parseFloat(supplierElement.find('.quantita-prima').val()) || 0;
        const remaining = quantitaPrima - distributedTotal;
        
        supplierElement.find('.remaining-value').text(remaining.toFixed(1));
        
        // Gestisci sezione trasferimento
        const transferSection = supplierElement.find('.transfer-section');
        if (remaining > 0) {
            transferSection.removeClass('hidden-field');
            supplierElement.find('.transfer-qty').val(remaining.toFixed(1));
        } else {
            transferSection.addClass('hidden-field');
            supplierElement.find('.transfer-qty').val('');
        }
        
        // Colore bordo
        if (remaining < 0) {
            supplierElement.find('.distribution-section').css('border-color', '#dc3545');
        } else if (remaining === 0) {
            supplierElement.find('.distribution-section').css('border-color', '#28a745');
        } else {
            supplierElement.find('.distribution-section').css('border-color', '#17a2b8');
        }
    }

    // Aggiorna opzioni trasferimento
    function updateTransferOptions() {
        $('.transfer-destination').each(function() {
            const currentSupplierIndex = $(this).closest('.supplier-row').data('supplier-index');
            $(this).empty().append('<option value="">Seleziona fornitore</option>');
            
            $('.supplier-row').each(function() {
                const index = $(this).data('supplier-index');
                if (index !== currentSupplierIndex) {
                    const nome = $(this).find('.nome-fornitore').val();
                    const altroNome = $(this).find('.altro-fornitore').val();
                    const displayName = nome === 'ALTRO' ? altroNome : nome;
                    
                    if (displayName) {
                        $(`.supplier-row[data-supplier-index="${currentSupplierIndex}"] .transfer-destination`)
                            .append(`<option value="${index}">F${index} - ${displayName}</option>`);
                    }
                }
            });
        });
    }

    // Esegui trasferimento
    function executeTransfer(sourceSupplierElement) {
        const sourceIndex = sourceSupplierElement.data('supplier-index');
        const targetIndex = sourceSupplierElement.find('.transfer-destination').val();
        const transferAmount = parseFloat(sourceSupplierElement.find('.transfer-qty').val()) || 0;
        
        if (!targetIndex) {
            alert('Seleziona il fornitore di destinazione');
            return;
        }
        
        if (transferAmount <= 0) {
            alert('Inserisci una quantità valida da trasferire');
            return;
        }
        
        const remaining = parseFloat(sourceSupplierElement.find('.remaining-value').text()) || 0;
        if (transferAmount > remaining) {
            alert('La quantità da trasferire non può essere superiore al rimanente');
            return;
        }
        
        const targetSupplierElement = $(`.supplier-row[data-supplier-index="${targetIndex}"]`);
        if (targetSupplierElement.length === 0) {
            alert('Fornitore di destinazione non trovato');
            return;
        }
        
        const sourceName = getSupplierDisplayName(sourceSupplierElement);
        const targetName = getSupplierDisplayName(targetSupplierElement);
        
        // Aggiorna quantità destinazione
        const currentTargetQty = parseFloat(targetSupplierElement.find('.quantita-prima').val()) || 0;
        const newTargetQty = currentTargetQty + transferAmount;
        targetSupplierElement.find('.quantita-prima').val(newTargetQty.toFixed(1));
        
        // Evidenzia come ricevente
        targetSupplierElement.find('.quantita-prima').addClass('received-transfer');
        
        // Aggiorna dettagli trasferimento
        updateTransferDetails(targetSupplierElement, sourceIndex, sourceName, transferAmount);
        
        // Salva trasferimento
        if (!transferData[targetIndex]) {
            transferData[targetIndex] = [];
        }
        transferData[targetIndex].push({
            fromSupplier: sourceIndex,
            fromName: sourceName,
            amount: transferAmount,
            timestamp: new Date().toLocaleTimeString('it-IT')
        });
        
        // Reset campi sorgente
        sourceSupplierElement.find('.transfer-destination').val('');
        sourceSupplierElement.find('.transfer-qty').val('');
        
        updateDistributionTotal(targetSupplierElement);
        updateDistributionTotal(sourceSupplierElement);
        updateTotals();
        
        alert(`Trasferimento completato!\n${transferAmount} kg trasferiti da F${sourceIndex} (${sourceName}) a F${targetIndex} (${targetName})\nNuova quantità F${targetIndex}: ${newTargetQty.toFixed(1)} kg`);
    }

    // Ottieni nome fornitore
    function getSupplierDisplayName(supplierElement) {
        const nome = supplierElement.find('.nome-fornitore').val();
        const altroNome = supplierElement.find('.altro-fornitore').val();
        return nome === 'ALTRO' ? altroNome : nome;
    }

    // Aggiorna dettagli trasferimento
    function updateTransferDetails(targetSupplierElement, sourceIndex, sourceName, amount) {
        const detailsContainer = targetSupplierElement.find('.transfer-details');
        detailsContainer.removeClass('hidden-field');
        
        let currentDetails = detailsContainer.html();
        const newDetail = `<div><strong>+${amount} kg</strong> ricevuti da F${sourceIndex} (${sourceName})</div>`;
        
        if (currentDetails) {
            detailsContainer.html(currentDetails + newDetail);
        } else {
            detailsContainer.html('<strong>Trasferimenti ricevuti:</strong>' + newDetail);
        }
    }

    // Aggiorna opzioni combinazioni
    function updateCombinazioniOptions() {
        const selectVerde = $('#combinazione-fornitori-verde');
        const selectAzzurro = $('#combinazione-fornitori-azzurro');
        const selectViola = $('#combinazione-fornitori-viola');
        
        selectVerde.empty().append('<option value="">Seleziona combinazione Verde</option>');
        selectAzzurro.empty().append('<option value="">Seleziona combinazione Azzurro</option>');
        selectViola.empty().append('<option value="">Seleziona combinazione Viola</option>');
        
        const fornitori = [];
        $('.supplier-row').each(function() {
            const index = $(this).data('supplier-index');
            const fornitore = $(this).find('.nome-fornitore').val() || '';
            const altroFornitore = $(this).find('.altro-fornitore').val();
            const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
            const certificazione = $(this).find('.certificazione-prodotto').val() || 'N/D';
            const lineaTrasformazione = $(this).find('.linea-trasformazione').val() || 'N/D';
            
            if (nomeFornitore) {
                fornitori.push({ 
                    index: index, 
                    nome: nomeFornitore,
                    certificazione: certificazione,
                    linea: lineaTrasformazione
                });
            }
        });
        
        // Combinazioni di 2 fornitori
        for (let i = 0; i < fornitori.length; i++) {
            for (let j = i + 1; j < fornitori.length; j++) {
                const combo = `${fornitori[i].index},${fornitori[j].index}`;
                const label = `F${fornitori[i].index} - ${fornitori[i].nome} + F${fornitori[j].index} - ${fornitori[j].nome}`;
                selectVerde.append(`<option value="${combo}">${label}</option>`);
                selectAzzurro.append(`<option value="${combo}">${label}</option>`);
                selectViola.append(`<option value="${combo}">${label}</option>`);
            }
        }
        
        // Combinazioni di 3 fornitori
        for (let i = 0; i < fornitori.length; i++) {
            for (let j = i + 1; j < fornitori.length; j++) {
                for (let k = j + 1; k < fornitori.length; k++) {
                    const combo = `${fornitori[i].index},${fornitori[j].index},${fornitori[k].index}`;
                    const label = `F${fornitori[i].index} - ${fornitori[i].nome} + F${fornitori[j].index} - ${fornitori[j].nome} + F${fornitori[k].index} - ${fornitori[k].nome}`;
                    selectVerde.append(`<option value="${combo}">${label}</option>`);
                    selectAzzurro.append(`<option value="${combo}">${label}</option>`);
                    selectViola.append(`<option value="${combo}">${label}</option>`);
                }
            }
        }
    }

    // Mostra/nasconde sezione combinazioni
    function toggleCombinazioniSection() {
        const hasSuppliers = $('.supplier-row').length > 0;
        
        if (hasSuppliers) {
            $('#combinazioni-section').removeClass('hidden-field');
        } else {
            $('#combinazioni-section').addClass('hidden-field');
        }
    }

    // Trova ultimo fornitore in combinazione
    function getLastSupplierInCombination(comboValue) {
        const indexes = comboValue.split(',').map(i => parseInt(i));
        const maxIndex = Math.max(...indexes);
        return $(`.supplier-row[data-supplier-index="${maxIndex}"]`);
    }

    // Applica combinazione
    function applyCombination(color) {
        const selectedCombo = $(`#combinazione-fornitori-${color}`).val();
        if (!selectedCombo) {
            alert(`Seleziona prima una combinazione ${color}`);
            return;
        }
        
        const indexes = selectedCombo.split(',');
        let combinationDetails = [];
        let combinationSupplierIndexes = indexes.map(i => parseInt(i));
        let totalCombination = 0;
        
        indexes.forEach(index => {
            const supplierRow = $(`.supplier-row[data-supplier-index="${index}"]`);
            
            const fornitore = supplierRow.find('.nome-fornitore').val() || '';
            const altroFornitore = supplierRow.find('.altro-fornitore').val();
            const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
            const certificazione = supplierRow.find('.certificazione-prodotto').val() || 'N/D';
            const lineaTrasformazione = supplierRow.find('.linea-trasformazione').val() || 'N/D';
            
            const quantitaTrasformata = parseFloat(supplierRow.find('.quantita-trasformata').val()) || 0;
            const resaPrima = parseFloat(supplierRow.find('.resa-prima').val()) || 0;
            
            if (quantitaTrasformata > 0) {
                const risultato = (quantitaTrasformata * resaPrima / 100);
                totalCombination += risultato;
                
                combinationDetails.push({
                    nome: nomeFornitore,
                    certificazione: certificazione,
                    linea: lineaTrasformazione,
                    quantita: quantitaTrasformata,
                    resa: resaPrima,
                    risultato: risultato.toFixed(1),
                    supplierIndex: parseInt(index)
                });
            }
        });
        
        const lastSupplierInCombo = getLastSupplierInCombination(selectedCombo);
        if (lastSupplierInCombo.length > 0) {
            const quantitaPrimaField = lastSupplierInCombo.find('.quantita-prima');
            quantitaPrimaField.val(totalCombination.toFixed(1));
            quantitaPrimaField.addClass('combination-result');
            quantitaPrimaField.attr('data-combination-type', color);
            
            const detailedCombination = combinationDetails.map(detail => 
                `F${detail.supplierIndex} - ${detail.nome} = ${detail.risultato}kg`
            ).join(' + ');
            
            // Salva combinazione
            combinationData[color] = {
                indexes: combinationSupplierIndexes,
                details: combinationDetails,
                totalCombination: totalCombination
            };
            
            // Mostra dettagli
            const combinationDetailsContainer = lastSupplierInCombo.find('.combination-details');
            combinationDetailsContainer.removeClass('hidden-field');
            combinationDetailsContainer.html(`<strong>Combinazione ${color.charAt(0).toUpperCase() + color.slice(1)}:</strong><br/>${detailedCombination}<br/><strong>Totale: ${totalCombination.toFixed(1)}kg</strong>`);
            
            updateDistributionTotal(lastSupplierInCombo);
            
            alert(`Combinazione ${color.charAt(0).toUpperCase() + color.slice(1)} applicata! Quantità totale: ${totalCombination.toFixed(1)} kg`);
        }
    }

    // Reset combinazione
    function resetCombination(color) {
        $('.supplier-row').each(function() {
            const quantitaPrimaField = $(this).find('.quantita-prima');
            const combinationType = quantitaPrimaField.attr('data-combination-type');
            
            if (quantitaPrimaField.hasClass('combination-result') && combinationType === color) {
                quantitaPrimaField.removeClass('combination-result');
                quantitaPrimaField.removeAttr('data-combination-type');
                
                $(this).find('.combination-details').addClass('hidden-field').html('');
                
                calculateYieldQuantities($(this));
                updateDistributionTotal($(this));
            }
        });
        
        $(`#combinazione-fornitori-${color}`).val('');
        
        combinationData[color] = { indexes: [], details: [], totalCombination: 0 };
        
        alert(`Combinazione ${color.charAt(0).toUpperCase() + color.slice(1)} rimossa. I valori sono stati ricalcolati.`);
    }

    // Aggiorna totali
    function updateTotals() {
        let totaleEntrata = 0;
        let totaleTrasformata = 0;
        let totaleGiacenza = 0;
        let totaleSuccoPrima = 0;
        let totaleSuccoSeconda = 0;
        let totaleTorchiato = 0;
        
        $('.supplier-row').each(function() {
            const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
            const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
            const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
            const succoPrima = parseFloat($(this).find('.quantita-prima').val()) || 0;
            const succoSeconda = parseFloat($(this).find('.quantita-seconda').val()) || 0;
            const torchiato = parseFloat($(this).find('.quantita-torchiato').val()) || 0;
            
            totaleEntrata += entrata;
            totaleTrasformata += trasformata;
            totaleGiacenza += giacenza;
            totaleSuccoPrima += succoPrima;
            totaleSuccoSeconda += succoSeconda;
            totaleTorchiato += torchiato;
        });
        
        $('#entrata-giornaliera').text(totaleEntrata.toLocaleString());
        $('#trasformata-totale').text(totaleTrasformata.toLocaleString());
        $('#giacenza-totale').text(totaleGiacenza.toLocaleString());
        $('#succo-prima-totale').text(totaleSuccoPrima.toFixed(1));
        $('#succo-seconda-totale').text(totaleSuccoSeconda.toFixed(1));
        $('#torchiato-totale').text(totaleTorchiato.toFixed(1));
        
        // Aggiorna riepilogo stampa
        $('#riepilogo-seconda').text(totaleSuccoSeconda.toFixed(1));
        $('#riepilogo-torchiato').text(totaleTorchiato.toFixed(1));
    }

    // Rinumerazione fornitori
    function renumberSuppliers() {
        let newCount = 0;
        $('.supplier-row').each(function() {
            newCount++;
            $(this).attr('data-supplier-index', newCount);
            updateSupplierHeader($(this));
        });
        supplierCount = newCount;
        updateCombinazioniOptions();
        updateTransferOptions();
    }

    // Aggiorna varietà in base al tipo di agrume
    function updateVarietyOptions() {
        const selectedAgrume = $('#tipo-agrume-giornaliero').val();
        
        $('.varieta-prodotto').each(function() {
            const currentValue = $(this).val();
            $(this).empty();
            $(this).append('<option value="">Seleziona varietà</option>');
            
            if (selectedAgrume && varietyOptions[selectedAgrume]) {
                varietyOptions[selectedAgrume].forEach(function(variety) {
                    $(this).append(`<option value="${variety.value}">${variety.text}</option>`);
                });
                
                if (currentValue) {
                    $(this).val(currentValue);
                }
            }
        });
    }

    // Gestione modal rese
    function openYieldsModal() {
        const selectedAgrume = $('#tipo-agrume-giornaliero').val();
        
        if (!selectedAgrume) {
            alert('Seleziona prima il tipo di agrume');
            return;
        }
        
        $('#agrume-selected').text(selectedAgrume);
        loadYieldsData(selectedAgrume);
        $('#yields-modal').fadeIn();
    }

    function closeYieldsModal() {
        $('#yields-modal').fadeOut();
    }

    function loadYieldsData(agrume) {
        if (yieldsData[agrume]) {
            const data = yieldsData[agrume];
            
            // Carica rese per ogni tipo e mese
            ['prima', 'seconda', 'torchiato'].forEach(type => {
                for (let month = 1; month <= 12; month++) {
                    const value = data[type] && data[type][month] ? data[type][month] : '';
                    $(`.yield-input[data-type="${type}"][data-month="${month}"]`).val(value);
                }
            });
        } else {
            $('.yield-input').val('');
        }
    }

    function saveYieldsData() {
        const selectedAgrume = $('#tipo-agrume-giornaliero').val();
        
        if (!selectedAgrume) {
            alert('Nessun agrume selezionato');
            return;
        }
        
        if (!yieldsData[selectedAgrume]) {
            yieldsData[selectedAgrume] = {
                prima: {},
                seconda: {},
                torchiato: {}
            };
        }
        
        ['prima', 'seconda', 'torchiato'].forEach(type => {
            for (let month = 1; month <= 12; month++) {
                const value = $(`.yield-input[data-type="${type}"][data-month="${month}"]`).val();
                if (value) {
                    yieldsData[selectedAgrume][type][month] = parseFloat(value);
                }
            }
        });
        
        showSaveStatus(`Rese salvate con successo per ${selectedAgrume}!`, 'success');
    }

    function resetYieldsData() {
        if (confirm('Sei sicuro di voler cancellare tutti i dati di resa per questo agrume?')) {
            $('.yield-input').val('');
            
            const selectedAgrume = $('#tipo-agrume-giornaliero').val();
            if (selectedAgrume && yieldsData[selectedAgrume]) {
                delete yieldsData[selectedAgrume];
            }
            
            showSaveStatus('Dati di resa cancellati', 'success');
        }
    }

    // Raccolta dati programma
    function collectProgramData() {
        const data = {
            tipoAgrume: $('#tipo-agrume-giornaliero').val(),
            dataLavorazione: $('#data-lavorazione').val(),
            ultimaRevisione: $('#last-revision').text(),
            
            transferData: transferData,
            combinationData: combinationData,
            yieldsData: yieldsData,
            
            fornitori: []
        };
        
        $('.supplier-row').each(function() {
            const destinazioniPrima = $(this).find('.destinazione-prima').val() || [];
            const linea = $(this).find('.linea-trasformazione').val();
            const supplierIndex = parseInt($(this).data('supplier-index'));
            
            // Raccolta dati distribuzione
            const distributionData = {};
            $(this).find('.distribution-qty').each(function() {
                const dest = $(this).data('dest');
                const qty = parseFloat($(this).val()) || 0;
                if (qty > 0) {
                    distributionData[dest] = qty;
                }
            });
            
            const receivedTransfers = transferData[supplierIndex] || [];
            
            const fornitore = {
                supplierIndex: supplierIndex,
                nome: $(this).find('.nome-fornitore').val(),
                altroNome: $(this).find('.altro-fornitore').val(),
                quantitaEntrata: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
                quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
                giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
                certificazione: $(this).find('.certificazione-prodotto').val(),
                altraCertificazione: $(this).find('.altra-certificazione').val(),
                varieta: $(this).find('.varieta-prodotto').val(),
                altraVarieta: $(this).find('.altra-varieta').val(),
                lineaTrasformazione: linea,
                portataImpianto: parseFloat($(this).find('.portata-impianto').val()) || 0,
                orarioInizio: $(this).find('.orario-inizio').val(),
                orarioFineDisplay: $(this).find('.orario-fine-display').text(),
                durataLavorazione: $(this).find('.durata-lavorazione').val(),
                
                rese: {
                    prima: parseFloat($(this).find('.resa-prima').val()) || 0,
                    seconda: linea === 'BOE/1100' ? (parseFloat($(this).find('.resa-seconda').val()) || 0) : 0,
                    torchiato: parseFloat($(this).find('.resa-torchiato').val()) || 0
                },
                
                quantitaProdotti: {
                    prima: parseFloat($(this).find('.quantita-prima').val()) || 0,
                    seconda: linea === 'BOE/1100' ? (parseFloat($(this).find('.quantita-seconda').val()) || 0) : 0,
                    torchiato: parseFloat($(this).find('.quantita-torchiato').val()) || 0
                },
                
                hasCombination: $(this).find('.quantita-prima').hasClass('combination-result'),
                combinationType: $(this).find('.quantita-prima').attr('data-combination-type') || '',
                hasReceivedTransfers: $(this).find('.quantita-prima').hasClass('received-transfer'),
                receivedTransfers: receivedTransfers,
                distributionData: distributionData,
                
                caratteristicheProdotti: {
                    prima: {
                        tenorePolpa: $(this).find('.tenore-polpa-prima').val(),
                        altroTenore: $(this).find('.altro-tenore-prima').val(),
                        brix: $(this).find('.brix-prima').val(),
                        altroBrix: $(this).find('.altro-brix-prima').val(),
                        bio: $(this).find('.bio-prima').val(),
                        pastorizzato: $(this).find('.pastorizzato-prima').val(),
                        conservato: $(this).find('.conservato-prima').val(),
                        note: $(this).find('.note-prima').val()
                    },
                    seconda: linea === 'BOE/1100' ? {
                        tenorePolpa: $(this).find('.tenore-polpa-seconda').val(),
                        altroTenore: $(this).find('.altro-tenore-seconda').val(),
                        brix: $(this).find('.brix-seconda').val(),
                        altroBrix: $(this).find('.altro-brix-seconda').val(),
                        pastorizzato: $(this).find('.pastorizzato-seconda').val(),
                        conservato: $(this).find('.conservato-seconda').val(),
                        note: $(this).find('.note-seconda').val()
                    } : null,
                    torchiato: {
                        tenorePolpa: $(this).find('.tenore-polpa-torchiato').val(),
                        altroTenore: $(this).find('.altro-tenore-torchiato').val(),
                        brix: $(this).find('.brix-torchiato').val(),
                        altroBrix: $(this).find('.altro-brix-torchiato').val(),
                        pastorizzato: $(this).find('.pastorizzato-torchiato').val(),
                        conservato: $(this).find('.conservato-torchiato').val(),
                        note: $(this).find('.note-torchiato').val()
                    }
                },
                
                destinazioni: {
                    prima: destinazioniPrima.join(', '),
                    primaAltro: $(this).find('.destinazione-prima').parent().find('.altra-destinazione').val() || '',
                    seconda: linea === 'BOE/1100' ? $(this).find('.destinazione-seconda').val() : '',
                    secondaAltro: linea === 'BOE/1100' ? ($(this).find('.destinazione-seconda').parent().find('.altra-destinazione').val() || '') : '',
                    torchiato: $(this).find('.destinazione-torchiato').val(),
                    torchiatoAltro: $(this).find('.destinazione-torchiato').parent().find('.altra-destinazione').val() || ''
                }
            };
            
            data.fornitori.push(fornitore);
        });
        
        return data;
    }

    // Salvataggio dati
    function saveData() {
        try {
            const data = collectProgramData();
            const dataString = JSON.stringify(data, null, 2);
            
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            const agrume = data.tipoAgrume || 'programma';
            const filename = `programma_${agrume}_${dateString}.json`;
            
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSaveStatus(`File ${filename} salvato con successo!`, 'success');
        } catch (error) {
            showSaveStatus('Errore durante il salvataggio: ' + error.message, 'error');
        }
    }

    // Caricamento dati
    function loadData() {
        $('#file-input').click();
    }

    $('#file-input').change(function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            showSaveStatus('Seleziona un file JSON valido', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                loadDataFromObject(data);
                showSaveStatus(`File ${file.name} caricato con successo!`, 'success');
            } catch (error) {
                showSaveStatus('Errore durante il caricamento: ' + error.message, 'error');
            }
        };
        reader.readAsText(file);
        
        $(this).val('');
    });

    function loadDataFromObject(data) {
        // Reset
        $('#fornitori-container').empty();
        supplierCount = 0;
        
        // Ripristina dati base
        $('#tipo-agrume-giornaliero').val(data.tipoAgrume || '');
        $('#data-lavorazione').val(data.dataLavorazione || '');
        $('#selected-agrume').text(data.tipoAgrume || 'N/D');
        
        // Ripristina dati globali
        transferData = data.transferData || {};
        combinationData = data.combinationData || {
            verde: { indexes: [], details: [], totalCombination: 0 },
            azzurro: { indexes: [], details: [], totalCombination: 0 },
            viola: { indexes: [], details: [], totalCombination: 0 }
        };
        yieldsData = data.yieldsData || {};
        
        // Ripristina fornitori
        if (data.fornitori && data.fornitori.length > 0) {
            data.fornitori.forEach(fornitoreData => {
                supplierCount = Math.max(supplierCount, fornitoreData.supplierIndex);
                const template = getSupplierTemplate(fornitoreData.supplierIndex);
                const newSupplier = $(template);
                
                $('#fornitori-container').append(newSupplier);
                
                // Ripristina tutti i dati
                const card = $(`.supplier-row[data-supplier-index="${fornitoreData.supplierIndex}"]`);
                
                // Dati base
                card.find('.nome-fornitore').val(fornitoreData.nome || '');
                card.find('.altro-fornitore').val(fornitoreData.altroNome || '');
                card.find('.quantita-fornitore').val(fornitoreData.quantitaEntrata || '');
                card.find('.quantita-trasformata').val(fornitoreData.quantitaTrasformata || '');
                card.find('.giacenza-fornitore').val(fornitoreData.giacenza || '');
                card.find('.certificazione-prodotto').val(fornitoreData.certificazione || '');
                card.find('.altra-certificazione').val(fornitoreData.altraCertificazione || '');
                card.find('.varieta-prodotto').val(fornitoreData.varieta || '');
                card.find('.altra-varieta').val(fornitoreData.altraVarieta || '');
                card.find('.linea-trasformazione').val(fornitoreData.lineaTrasformazione || '');
                card.find('.portata-impianto').val(fornitoreData.portataImpianto || '');
                card.find('.orario-inizio').val(fornitoreData.orarioInizio || '');
                card.find('.orario-fine-display').text(fornitoreData.orarioFineDisplay || '');
                card.find('.durata-lavorazione').val(fornitoreData.durataLavorazione || '');
                
                // Rese
                if (fornitoreData.rese) {
                    card.find('.resa-prima').val(fornitoreData.rese.prima || '');
                    card.find('.resa-seconda').val(fornitoreData.rese.seconda || '');
                    card.find('.resa-torchiato').val(fornitoreData.rese.torchiato || '');
                }
                
                // Quantità prodotti
                if (fornitoreData.quantitaProdotti) {
                    card.find('.quantita-prima').val(fornitoreData.quantitaProdotti.prima || '');
                    card.find('.quantita-seconda').val(fornitoreData.quantitaProdotti.seconda || '');
                    card.find('.quantita-torchiato').val(fornitoreData.quantitaProdotti.torchiato || '');
                }
                
                // Destinazioni
                if (fornitoreData.destinazioni) {
                    if (fornitoreData.destinazioni.prima) {
                        const destinazioni = fornitoreData.destinazioni.prima.split(', ');
                        card.find('.destinazione-prima').val(destinazioni);
                    }
                    card.find('.destinazione-seconda').val(fornitoreData.destinazioni.seconda || '');
                    card.find('.destinazione-torchiato').val(fornitoreData.destinazioni.torchiato || '');
                }
                
                // Caratteristiche prodotti
                if (fornitoreData.caratteristicheProdotti) {
                    const car = fornitoreData.caratteristicheProdotti;
                    
                    if (car.prima) {
                        card.find('.tenore-polpa-prima').val(car.prima.tenorePolpa || 'STANDARD');
                        card.find('.altro-tenore-prima').val(car.prima.altroTenore || '');
                        card.find('.brix-prima').val(car.prima.brix || 'NAT');
                        card.find('.altro-brix-prima').val(car.prima.altroBrix || '');
                        card.find('.bio-prima').val(car.prima.bio || 'SI');
                        card.find('.pastorizzato-prima').val(car.prima.pastorizzato || 'SI');
                        card.find('.conservato-prima').val(car.prima.conservato || 'NO');
                        card.find('.note-prima').val(car.prima.note || '');
                    }
                    
                    if (car.seconda) {
                        card.find('.tenore-polpa-seconda').val(car.seconda.tenorePolpa || '<1%');
                        card.find('.altro-tenore-seconda').val(car.seconda.altroTenore || '');
                        card.find('.brix-seconda').val(car.seconda.brix || 'NAT');
                        card.find('.altro-brix-seconda').val(car.seconda.altroBrix || '');
                        card.find('.pastorizzato-seconda').val(car.seconda.pastorizzato || 'SI');
                        card.find('.conservato-seconda').val(car.seconda.conservato || 'SI');
                        card.find('.note-seconda').val(car.seconda.note || 'SERB. ESTERNI');
                    }
                    
                    if (car.torchiato) {
                        card.find('.tenore-polpa-torchiato').val(car.torchiato.tenorePolpa || '<1%');
                        card.find('.altro-tenore-torchiato').val(car.torchiato.altroTenore || '');
                        card.find('.brix-torchiato').val(car.torchiato.brix || '45');
                        card.find('.altro-brix-torchiato').val(car.torchiato.altroBrix || '');
                        card.find('.pastorizzato-torchiato').val(car.torchiato.pastorizzato || 'SI');
                        card.find('.conservato-torchiato').val(car.torchiato.conservato || 'NO');
                        card.find('.note-torchiato').val(car.torchiato.note || '');
                    }
                }
                
                // Gestisci campi altro
                if (fornitoreData.nome === 'ALTRO') {
                    card.find('.altro-fornitore').removeClass('hidden-field');
                }
                if (fornitoreData.certificazione === 'ALTRO') {
                    card.find('.altra-certificazione').removeClass('hidden-field');
                }
                if (fornitoreData.varieta === 'ALTRO') {
                    card.find('.altra-varieta').removeClass('hidden-field');
                }
                
                // Ripristina combinazioni
                if (fornitoreData.hasCombination) {
                    card.find('.quantita-prima').addClass('combination-result');
                    if (fornitoreData.combinationType) {
                        card.find('.quantita-prima').attr('data-combination-type', fornitoreData.combinationType);
                    }
                }
                
                // Ripristina trasferimenti
                if (fornitoreData.hasReceivedTransfers) {
                    card.find('.quantita-prima').addClass('received-transfer');
                }
                
                // Inizializza eventi
                card.find('.destinazione-prima').select2({
                    placeholder: "Seleziona fino a 3 destinazioni",
                    maximumSelectionLength: 3
                });
                
                attachSupplierEvents(card);
                toggleSecondaSection(card);
                updateBioStyles(card);
                updateDistributionSection(card);
            });
        }
        
        updateVarietyOptions();
        updateTotals();
        updateCombinazioniOptions();
        toggleCombinazioniSection();
        updateCounts();
        updateTransferOptions();
    }

    // Status salvataggio
    function showSaveStatus(message, type) {
        const statusDiv = $('#save-status');
        const messageSpan = $('#save-message');
        
        messageSpan.text(message);
        
        if (type === 'error') {
            statusDiv.addClass('error');
        } else {
            statusDiv.removeClass('error');
        }
        
        statusDiv.fadeIn();
        
        setTimeout(() => {
            statusDiv.fadeOut();
        }, 3000);
    }

    // Eventi principali
    $('#tipo-agrume-giornaliero').change(function() {
        const agrume = $(this).val();
        $('#selected-agrume').text(agrume || 'N/D');
        
        updateVarietyOptions();
        
        if (agrume && defaultYields[agrume]) {
            const yields = defaultYields[agrume];
            
            $('.supplier-row').each(function() {
                $(this).find('.resa-prima').val(yields.prima);
                $(this).find('.resa-seconda').val(yields.seconda);
                $(this).find('.resa-torchiato').val(yields.torchiato);
                
                calculateYieldQuantities($(this));
                updateDistributionTotal($(this));
            });
            
            updateTotals();
        }
    });

    $('#aggiungi-fornitore').click(function() {
        addSupplier();
    });

    // Eventi combinazioni
    $('#applica-combinazione-verde').click(function() {
        applyCombination('verde');
    });

    $('#reset-combinazione-verde').click(function() {
        resetCombination('verde');
    });

    $('#applica-combinazione-azzurro').click(function() {
        applyCombination('azzurro');
    });

    $('#reset-combinazione-azzurro').click(function() {
        resetCombination('azzurro');
    });

    $('#applica-combinazione-viola').click(function() {
        applyCombination('viola');
    });

    $('#reset-combinazione-viola').click(function() {
        resetCombination('viola');
    });

    // Eventi modal rese
    $('#rese-button').click(function() {
        openYieldsModal();
    });

    $('.close-yields').click(function() {
        closeYieldsModal();
    });

    $('#salva-rese').click(function() {
        saveYieldsData();
    });

    $('#reset-rese').click(function() {
        resetYieldsData();
    });

    $(window).click(function(event) {
        if (event.target.id === 'yields-modal') {
            closeYieldsModal();
        }
    });

    // Eventi salvataggio/caricamento
    $('#salva-dati').click(function() {
        saveData();
    });

    $('#carica-dati').click(function() {
        if (confirm('Il caricamento sovrascriverà tutti i dati attuali. Continuare?')) {
            loadData();
        }
    });

    $('#reset-programma').click(function() {
        if (confirm('Attenzione: questa operazione cancellerà tutti i dati. Continuare?')) {
            location.reload();
        }
    });

    // Auto-save ogni 30 secondi
    setInterval(function() {
        const hasData = $('.supplier-row').length > 0;
        if (hasData) {
            try {
                const data = collectProgramData();
                localStorage.setItem('autoSaveData', JSON.stringify(data));
            } catch (error) {
                console.log('Errore auto-save:', error);
            }
        }
    }, 30000);

    // Ripristino auto-save all'avvio
    function checkAutoSave() {
        const autoSaveData = localStorage.getItem('autoSaveData');
        if (autoSaveData) {
            if (confirm('Trovati dati salvati automaticamente. Vuoi ripristinarli?')) {
                try {
                    const data = JSON.parse(autoSaveData);
                    loadDataFromObject(data);
                    showSaveStatus('Dati auto-salvati ripristinati', 'success');
                } catch (error) {
                    localStorage.removeItem('autoSaveData');
                }
            } else {
                localStorage.removeItem('autoSaveData');
            }
        }
    }

    // Gestione chiusura pagina
    window.addEventListener('beforeunload', function(e) {
        const hasUnsavedData = $('.supplier-row').length > 0;
        if (hasUnsavedData) {
            e.preventDefault();
            e.returnValue = 'Ci sono dati non salvati. Vuoi davvero uscire?';
        }
    });

    // Tasti scorciatoia
    $(document).keydown(function(e) {
        if (e.ctrlKey) {
            switch(e.which) {
                case 83: // Ctrl+S - Salva
                    e.preventDefault();
                    saveData();
                    break;
                case 79: // Ctrl+O - Apri
                    e.preventDefault();
                    $('#carica-dati').click();
                    break;
                case 80: // Ctrl+P - Stampa
                    e.preventDefault();
                    window.print();
                    break;
                case 78: // Ctrl+N - Nuovo fornitore
                    e.preventDefault();
                    $('#aggiungi-fornitore').click();
                    break;
            }
        }
    });

    // Validazione dati
    function validateData() {
        let isValid = true;
        let errors = [];
        
        $('.supplier-row').each(function() {
            const index = $(this).data('supplier-index');
            const nome = $(this).find('.nome-fornitore').val();
            const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
            const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
            
            if (!nome) {
                errors.push(`F${index}: Nome fornitore mancante`);
                isValid = false;
            }
            
            if (trasformata > entrata) {
                errors.push(`F${index}: Quantità trasformata superiore all'entrata`);
                isValid = false;
            }
        });
        
        if (!$('#tipo-agrume-giornaliero').val()) {
            errors.push('Tipo di agrume non selezionato');
            isValid = false;
        }
        
        if (!$('#data-lavorazione').val()) {
            errors.push('Data di lavorazione non inserita');
            isValid = false;
        }
        
        if (!isValid) {
            alert('Errori di validazione:\n' + errors.join('\n'));
        }
        
        return isValid;
    }

    // Controllo responsive per mobile
    function checkMobileView() {
        if (window.innerWidth < 768) {
            alert('Per una migliore esperienza su dispositivi mobili, si consiglia di ruotare il dispositivo in modalità landscape.');
        }
    }

    // Inizializzazione completa
    initApp();
    checkAutoSave();
    checkMobileView();

    // Event listener per il ridimensionamento finestra
    $(window).resize(function() {
        checkMobileView();
    });

    console.log('Sistema Programma Giornaliero Trasformazione inizializzato con successo');
    console.log('Versione ottimizzata per stampa con layout migliorato');
    console.log('Tasti scorciatoia: Ctrl+S (Salva), Ctrl+O (Apri), Ctrl+P (Stampa), Ctrl+N (Nuovo Fornitore)');
});
</script>
</body>
</html>
